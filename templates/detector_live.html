<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pose Challenge ‚Äì Match the Pose</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <link rel="prefetch" href="/result">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: url("{{ url_for('static', filename='521461.jpg') }}") no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', sans-serif;
    }

    .overlay {
      backdrop-filter: blur(25px);
      background-color: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 25px;
      max-width: 880px;
      margin: 40px auto;
      text-align: center;
      box-shadow: 0 0 35px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    #output {
      border-radius: 20px;
      border: 3px solid #888;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
      margin-top: 25px;
    }

    #result {
      font-size: 1.3rem;
      margin-top: 15px;
      color: #fff;
      font-weight: bold;
      text-shadow: 0 0 6px rgba(0,0,0,0.4);
    }

    #timer {
      font-size: 1.2rem;
      color: #ffe57f;
      font-weight: bold;
      margin-top: 10px;
    }

    .info-box {
      margin-top: 18px;
      font-size: 1.15rem;
      color: #fefefe;
      text-shadow: 0 0 5px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h2 class="mb-3">üßò Extrovert Mode ‚Äì Hold the Target Pose!</h2>
    <img src="{{ url_for('static', filename=pose_img) }}" alt="Target Pose" class="pose-img" style="width:220px; border-radius: 15px; margin-bottom: 12px; border: 2px solid #ccc;">
    <div class="text-muted mb-3">Try to match this pose ‚òùÔ∏è</div>

    <video id="webcam" autoplay playsinline muted style="display:none;"></video>
    <canvas id="output" width="640" height="480"></canvas>

    <div id="result">üì∏ Waiting for pose feedback...</div>
    <div id="timer">‚è≥ Time Left: <span id="countdown">10</span>s</div>

    <div class="info-box">
      <p>üí° Make sure your whole body is visible in the webcam view.</p>
      <p>‚è≥ Hold the pose correctly for a few seconds to score!</p>
    </div>
  </div>

  <script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const resultBox = document.getElementById('result');
    const countdownEl = document.getElementById('countdown');

    let matchFrames = 0;
    const holdThreshold = 5;
    let matched = false;
    let countdown = 10;
    let timer = null;

    const pose = new Pose.Pose({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    pose.onResults(res => {
      if (matched) return;
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);

      if (res.poseLandmarks) {
        drawConnectors(ctx, res.poseLandmarks, Pose.POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
        drawLandmarks(ctx, res.poseLandmarks, {color: '#FF0000', lineWidth: 2});

        const [lw, rw, ls, rs] = [15, 16, 11, 12].map(i => res.poseLandmarks[i]);

        if (lw.y < ls.y && rw.y < rs.y) {
          matchFrames++;
          resultBox.innerText = `‚úÖ Holding pose (${matchFrames}/${holdThreshold})`;
        } else {
          matchFrames = 0;
          resultBox.innerText = `‚ùå Pose not matched`;
        }

        if (matchFrames >= holdThreshold && !matched) {
          matched = true;
          goToLoading();
        }
      }
      ctx.restore();
    });

    const camera = new Camera(video, {
      onFrame: async () => {
        await pose.send({image: video});
      },
      width: 640,
      height: 480
    });
    camera.start();

    function goToLoading() {
      clearInterval(timer);
      document.body.innerHTML = `
        <div style="color:white;text-align:center;padding-top:100px;font-size:24px;">
          üéØ Pose Matched!<br><br>Loading your result...
          <div class="spinner-border text-light" role="status" style="margin-top: 20px;"></div>
        </div>`;
      setTimeout(() => window.location.replace("/loading"), 500);
    }

    timer = setInterval(() => {
      countdown--;
      countdownEl.textContent = countdown;
      if (countdown <= 0 && !matched) {
        clearInterval(timer);
        resultBox.innerText = `‚è∞ Time's up! Redirecting...`;
        goToLoading();
      }
    }, 1000);
  </script>
</body>
</html>
